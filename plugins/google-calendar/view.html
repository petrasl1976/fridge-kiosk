{% if plugin['data'] %}
  {# Debug info removed #}

  {% if plugin['data'].error %}
  <div class="calendar-widget" style="
      font-size: {{ plugin['config'].format.font_size }};
      color: red;
      padding: {{ plugin['config'].format.padding }};
  ">
    <h3>Google Calendar Error</h3>
    <p>{{ plugin['data'].error }}</p>
    <p>Make sure you have:<br>
    1. Placed client_secret.json in the config folder<br>
    2. Forwarded port if accessing via SSH (e.g., ssh -L 8090:localhost:8090 user@host)<br>
    3. Complete the authentication in a browser when prompted</p>
  </div>
  {% elif plugin['data'].weeks %}
  <div class="calendar-widget" style="font-size: {{ plugin['config'].format.font_size }}; color: {{ plugin['config'].format.color }}; padding: {{ plugin['config'].format.padding }};">
    <table class="calendar-table" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th>Pir</th>
          <th>Ant</th>
          <th>Tre</th>
          <th>Ket</th>
          <th>Pen</th>
          <th>Šeš</th>
          <th>Sek</th>
        </tr>
      </thead>
      <tbody>
        {% set today = plugin['data'].today %}
        {% set holidays = plugin['config'].holidays %}
        {% for week in plugin['data'].weeks %}
          <tr>
            {% for day in week %}
              {% set day_str = day.date_str %}
              {% set events = plugin['data'].events_by_day.get(day_str, []) %}
              {% set is_holiday = holidays and holidays[day_str] is defined %}
              {% set is_weekend = day.weekday == 5 or day.weekday == 6 %}
              {% set cell_bg = '#222' %}
              {% set cell_color = '#eee' %}
              {% if is_weekend or is_holiday %}
                {% set cell_bg = '#f5f5f5' %}
                {% set cell_color = '#222' %}
              {% endif %}
              {% if day_str == today %}
                <td style="background: #4CAF50; color: #fff; text-align: center; font-weight: bold; vertical-align: top;">
                  <div class="cell-inner">
                    <div>{{ day.day }}</div>
                    {% if is_holiday %}
                      <div class="holiday">{{ holidays[day_str] }}</div>
                    {% endif %}
                    <div class="events">
                      {% if events %}
                        <ul>
                          {% for event in events %}
                            <li style="background: {{ event.color }}; color: #fff; margin: 2px 0; padding: 2px 4px; border-radius: 3px; font-size: 0.9em;">
                              {{ event.formatted_time if event.formatted_time }} {{ event.summary }}
                            </li>
                          {% endfor %}
                        </ul>
                      {% endif %}
                    </div>
                  </div>
                </td>
              {% else %}
                <td style="background: {{ cell_bg }}; color: {{ cell_color }}; text-align: center; vertical-align: top; box-shadow: 0 1px 4px #0002;">
                  <div class="cell-inner">
                    <div style="text-shadow: 0 1px 4px #fff, 0 0 2px #000;">{{ day.day }}</div>
                    {% if is_holiday %}
                      <div class="holiday">{{ holidays[day_str] }}</div>
                    {% endif %}
                    <div class="events">
                      {% if events %}
                        <ul>
                          {% for event in events %}
                            <li style="background: {{ event.color }}; color: #fff; margin: 2px 0; padding: 2px 4px; border-radius: 3px; font-size: 0.9em;">
                              {{ event.formatted_time if event.formatted_time }} {{ event.summary }}
                            </li>
                          {% endfor %}
                        </ul>
                      {% endif %}
                    </div>
                  </div>
                </td>
              {% endif %}
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="calendar-widget" style="
      font-size: {{ plugin['config'].format.font_size }};
      color: orange;
      padding: {{ plugin['config'].format.padding }};
  ">
    <h3>Calendar Initializing</h3>
    <p>If this message persists, there may be an issue with Google Calendar authentication.</p>
    <p>Make sure you have:<br>
    1. Placed client_secret.json in the config folder<br>
    2. Run the authentication server with:<br>
       python3 -m backend.utils.auth.google_auth_server --service "Google Calendar"<br>
    3. Visit the URL displayed by the server in your browser to authenticate</p>
  </div>
  {% endif %}
{% else %}
<div class="calendar-widget" style="color: red; padding: 20px;">
  <h3>Google Calendar Plugin Error</h3>
  <p>No data available from the plugin.</p>
</div>
{% endif %} 